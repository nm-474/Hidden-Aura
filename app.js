function textToBinary(text){return text.split('').map(c=>c.charCodeAt(0).toString(2).padStart(8,'0')).join('');}
function binaryToText(binary){let out='';for(let i=0;i<binary.length;i+=8)out+=String.fromCharCode(parseInt(binary.slice(i,i+8),2));return out;}
function encryptMessage(message,password){return CryptoJS.AES.encrypt(message,password).toString();}
function decryptMessage(cipherText,password){try{const bytes=CryptoJS.AES.decrypt(cipherText,password);const text=bytes.toString(CryptoJS.enc.Utf8);if(!text)throw new Error('Wrong password or corrupt data');return text;}catch{return 'Invalid password or corrupted data';}}
async function encodeImage(){const f=document.getElementById('coverImage');const m=document.getElementById('secretText').value.trim();const p=document.getElementById('password').value.trim();const d=document.getElementById('downloadLink');if(!f.files[0])return alert('Select image');if(!m)return alert('Enter message');if(!p)return alert('Enter password');const enc=encryptMessage(m,p);const bin=textToBinary(enc);const len=bin.length.toString(2).padStart(32,'0');const full=len+bin;const img=await loadImage(f.files[0]);const c=document.createElement('canvas');const ctx=c.getContext('2d');c.width=img.width;c.height=img.height;ctx.drawImage(img,0,0);const data=ctx.getImageData(0,0,img.width,img.height);const px=data.data;if(full.length>px.length/4){alert('Message too long');return;}for(let i=0;i<full.length;i++){px[i*4]=(px[i*4]&0xfe)|parseInt(full[i]);}ctx.putImageData(data,0,0);d.href=c.toDataURL('image/png');d.classList.remove('hidden');alert('✅ Message hidden!');}
async function decodeImage(){const f=document.getElementById('stegoImage').files[0];const p=document.getElementById('decodePassword').value.trim();const o=document.getElementById('revealedMessage');if(!f)return alert('Upload stego image');if(!p)return alert('Enter password');const img=await loadImage(f);const c=document.createElement('canvas');const ctx=c.getContext('2d');c.width=img.width;c.height=img.height;ctx.drawImage(img,0,0);const data=ctx.getImageData(0,0,img.width,img.height);const px=data.data;let lenBits='';for(let i=0;i<32;i++){lenBits+=(px[i*4]&1).toString();}const msgLen=parseInt(lenBits,2);if(!msgLen||isNaN(msgLen)){alert('No message');return;}let msgBits='';for(let i=32;i<32+msgLen;i++){msgBits+=(px[i*4]&1).toString();}const enc=binaryToText(msgBits);const dec=decryptMessage(enc,p);o.textContent=dec;o.classList.add(dec.includes('Invalid')?'text-red-400':'text-green-400');alert(dec.includes('Invalid')?'❌ Wrong password':'✅ Message revealed!');}
function loadImage(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=e=>{const img=new Image();img.onload=()=>res(img);img.onerror=rej;img.src=e.target.result;};r.readAsDataURL(file);});}